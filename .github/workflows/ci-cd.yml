name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_USERNAME: ${{ github.repository_owner }}

jobs:
  # ========== Java ì„œë¹„ìŠ¤ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ==========
  build-java-services:
    name: Build Java Services (terra-sense, terra-ops)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [terra-sense, terra-ops]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ”§ Grant Execute Permission for Gradlew
        run: chmod +x services/${{ matrix.service }}/gradlew
        
      - name: ğŸ—ï¸ Build with Gradle
        run: |
          cd services/${{ matrix.service }}
          ./gradlew build --no-daemon
          
      - name: ğŸ§ª Run Tests
        run: |
          cd services/${{ matrix.service }}
          ./gradlew test --no-daemon
          
      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.service }}
          path: services/${{ matrix.service }}/build/test-results/

  # ========== Python ì„œë¹„ìŠ¤ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ==========
  build-python-service:
    name: Build Python Service (terra-cortex)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd services/terra-cortex
          pip install -r requirements.txt
          pip install pytest pytest-cov
          
      - name: ğŸ” Lint with Flake8
        run: |
          pip install flake8
          cd services/terra-cortex
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
          
      - name: ğŸ§ª Run Tests
        run: |
          cd services/terra-cortex
          pytest --cov=src --cov-report=xml || echo "No tests found"

  # ========== Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ ==========
  build-and-push-images:
    name: Build & Push Docker Images
    needs: [build-java-services, build-python-service]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [terra-sense, terra-cortex, terra-ops]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/terraneuron-${{ matrix.service }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/terraneuron-${{ matrix.service }}:${{ github.sha }}

  # ========== E2E í…ŒìŠ¤íŠ¸ ==========
  e2e-test:
    name: E2E Integration Test
    needs: [build-java-services, build-python-service]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Start Docker Compose Stack
        run: docker-compose up -d

      - name: â³ Wait for Services
        run: sleep 60

      - name: ğŸ Setup Python for E2E Tests
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Test Dependencies
        run: pip install requests

      - name: ğŸ§ª Run E2E Tests
        run: python tests/neural-flow-test.py

      - name: ğŸ›‘ Stop Docker Compose
        if: always()
        run: docker-compose down -v
