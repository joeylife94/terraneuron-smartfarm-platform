version: '3.8'

services:
  # ========== 인프라 레이어 ==========
  
  redis:
    image: redis:7-alpine
    container_name: terraneuron-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass terra2025
    networks:
      - terraneuron-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: terraneuron-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - terraneuron-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: terraneuron-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - terraneuron-net

  mysql:
    image: mysql:8.0
    container_name: terraneuron-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: terra_db
      MYSQL_USER: terra
      MYSQL_PASSWORD: terra2025
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./infra/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - terraneuron-net

  influxdb:
    image: influxdb:2.7
    container_name: terraneuron-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: terra2025
      DOCKER_INFLUXDB_INIT_ORG: terraneuron
      DOCKER_INFLUXDB_INIT_BUCKET: sensor_data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: terra-token-2025
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - terraneuron-net

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: terraneuron-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./infra/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    networks:
      - terraneuron-net

  # ========== 모니터링 레이어 ==========
  
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: terraneuron-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - terraneuron-net

  grafana:
    image: grafana/grafana:10.2.0
    container_name: terraneuron-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: terra2025
      GF_INSTALL_PLUGINS: grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - terraneuron-net

  kafka-exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: terraneuron-kafka-exporter
    command:
      - '--kafka.server=kafka:29092'
    ports:
      - "9308:9308"
    depends_on:
      - kafka
    networks:
      - terraneuron-net

  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: terraneuron-mysql-exporter
    environment:
      DATA_SOURCE_NAME: "terra:terra2025@(mysql:3306)/terra_db"
    ports:
      - "9104:9104"
    depends_on:
      - mysql
    networks:
      - terraneuron-net

  # ========== 마이크로서비스 레이어 ==========
  
  terra-gateway:
    build:
      context: ./services/terra-gateway
      dockerfile: Dockerfile
    container_name: terra-gateway
    depends_on:
      - redis
      - terra-sense
      - terra-cortex
      - terra-ops
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8000:8000"
    networks:
      - terraneuron-net

  terra-sense:
    build:
      context: ./services/terra-sense
      dockerfile: Dockerfile
    container_name: terra-sense
    depends_on:
      - kafka
      - influxdb
      - mosquitto
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MQTT_BROKER_URL: tcp://mosquitto:1883
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: terra-token-2025
      INFLUXDB_ORG: terraneuron
      INFLUXDB_BUCKET: sensor_data
    ports:
      - "8081:8081"
    networks:
      - terraneuron-net

  terra-cortex:
    build:
      context: ./services/terra-cortex
      dockerfile: Dockerfile
    container_name: terra-cortex
    depends_on:
      - kafka
      - terra-ops
      - influxdb
    volumes:
      - ./services/terra-cortex/src:/app/src
      # 호스트의 data 폴더(PDF 넣을 곳)를 컨테이너 내부의 /app/data로 연결
      - ./services/terra-cortex/data:/app/data  
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_INPUT_TOPIC: raw-sensor-data
      KAFKA_OUTPUT_TOPIC: processed-insights
      # Hybrid AI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}  # For Ollama use "ollama", for OpenAI use real key
      OPENAI_MODEL: ${OPENAI_MODEL:-llama3.1}  # For Ollama: llama3.1, mistral, etc. For OpenAI: gpt-4o-mini
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}  # Ollama endpoint (use host.docker.internal for local Ollama)
      # Weather API (OpenWeatherMap 무료 tier: https://openweathermap.org/api)
      WEATHER_API_KEY: ${WEATHER_API_KEY:-}           # OpenWeatherMap API Key (비어있으면 비활성화)
      WEATHER_PROVIDER: ${WEATHER_PROVIDER:-openweathermap}
      WEATHER_LAT: ${WEATHER_LAT:-35.1796}            # 농장 위도 (기본: 대전)
      WEATHER_LON: ${WEATHER_LON:-129.0756}            # 농장 경도 (기본: 부산)
      # Crop Profile (terra-ops 연동 — 작물 모델링 Step 2)
      TERRA_OPS_URL: http://terra-ops:8080             # terra-ops REST API 주소
      CROP_CACHE_TTL: ${CROP_CACHE_TTL:-1800}          # 작물 프로필 캐시 TTL (30분)
      # Time Series Trend Analyzer (InfluxDB 시계열 분석 — Step 3)
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: terra-token-2025
      INFLUXDB_ORG: terraneuron
      INFLUXDB_BUCKET: sensor_data
      TREND_CACHE_TTL: ${TREND_CACHE_TTL:-120}           # 추세 캐시 TTL (2분)
      TREND_WINDOW: ${TREND_WINDOW:-1h}                  # 기본 분석 윈도우
      # Knowledge Accumulation Pipeline (지식 축적 — Step 6)
      KNOWLEDGE_COLLECT_INTERVAL: ${KNOWLEDGE_COLLECT_INTERVAL:-60}  # 자동 수집 주기 (분)
      KNOWLEDGE_BASE_PATH: /app/data/knowledge_base
      CHROMA_DB_PATH: /app/data/chroma_db
    ports:
      - "8082:8082"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow Docker to access host machine (for local Ollama)
    networks:
      - terraneuron-net

  terra-ops:
    build:
      context: ./services/terra-ops
      dockerfile: Dockerfile
    container_name: terra-ops
    depends_on:
      - kafka
      - mysql
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/terra_db
      SPRING_DATASOURCE_USERNAME: terra
      SPRING_DATASOURCE_PASSWORD: terra2025
    ports:
      - "8080:8080"
    networks:
      - terraneuron-net

  # ========== 농업인 대시보드 ==========

  terra-dashboard:
    build:
      context: ./services/terra-dashboard
      dockerfile: Dockerfile
    container_name: terra-dashboard
    depends_on:
      - terra-cortex
      - terra-ops
      - terra-sense
    ports:
      - "3001:3000"
    environment:
      NODE_ENV: production
    networks:
      - terraneuron-net

  # ========== 데이터 수집 레이어 (선택적) ==========

  terra-data-collector:
    build:
      context: ./services/terra-data-collector
      dockerfile: Dockerfile
    container_name: terra-data-collector
    depends_on:
      - terra-sense
    environment:
      TERRA_SENSE_URL: http://terra-sense:8081
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      COLLECTOR_LOG_LEVEL: INFO
    ports:
      - "8083:8083"
    volumes:
      - ./services/terra-data-collector/data:/app/data
      - ./services/terra-data-collector/config.yaml:/app/config.yaml
    profiles:
      - data-collector   # docker compose --profile data-collector up 으로만 시작
    networks:
      - terraneuron-net

networks:
  terraneuron-net:
    driver: bridge

volumes:
  mysql-data:
  influxdb-data:
  mosquitto-data:
  mosquitto-logs:
  prometheus-data:
  grafana-data:
