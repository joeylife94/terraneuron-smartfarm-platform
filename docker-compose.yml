version: '3.8'

services:
  # ========== 인프라 레이어 ==========
  
  redis:
    image: redis:7-alpine
    container_name: terraneuron-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass terra2025
    networks:
      - terraneuron-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: terraneuron-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - terraneuron-net

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: terraneuron-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - terraneuron-net

  mysql:
    image: mysql:8.0
    container_name: terraneuron-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: terra_db
      MYSQL_USER: terra
      MYSQL_PASSWORD: terra2025
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./infra/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - terraneuron-net

  influxdb:
    image: influxdb:2.7
    container_name: terraneuron-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: terra2025
      DOCKER_INFLUXDB_INIT_ORG: terraneuron
      DOCKER_INFLUXDB_INIT_BUCKET: sensor_data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: terra-token-2025
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - terraneuron-net

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: terraneuron-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./infra/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    networks:
      - terraneuron-net

  # ========== 모니터링 레이어 ==========
  
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: terraneuron-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - terraneuron-net

  grafana:
    image: grafana/grafana:10.2.0
    container_name: terraneuron-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: terra2025
      GF_INSTALL_PLUGINS: grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - terraneuron-net

  kafka-exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: terraneuron-kafka-exporter
    command:
      - '--kafka.server=kafka:29092'
    ports:
      - "9308:9308"
    depends_on:
      - kafka
    networks:
      - terraneuron-net

  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: terraneuron-mysql-exporter
    environment:
      DATA_SOURCE_NAME: "terra:terra2025@(mysql:3306)/terra_db"
    ports:
      - "9104:9104"
    depends_on:
      - mysql
    networks:
      - terraneuron-net

  # ========== 마이크로서비스 레이어 ==========
  
  terra-gateway:
    build:
      context: ./services/terra-gateway
      dockerfile: Dockerfile
    container_name: terra-gateway
    depends_on:
      - redis
      - terra-sense
      - terra-cortex
      - terra-ops
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8000:8000"
    networks:
      - terraneuron-net

  terra-sense:
    build:
      context: ./services/terra-sense
      dockerfile: Dockerfile
    container_name: terra-sense
    depends_on:
      - kafka
      - influxdb
      - mosquitto
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MQTT_BROKER_URL: tcp://mosquitto:1883
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: terra-token-2025
      INFLUXDB_ORG: terraneuron
      INFLUXDB_BUCKET: sensor_data
    ports:
      - "8081:8081"
    networks:
      - terraneuron-net

  terra-cortex:
    build:
      context: ./services/terra-cortex
      dockerfile: Dockerfile
    container_name: terra-cortex
    depends_on:
      - kafka
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_INPUT_TOPIC: raw-sensor-data
      KAFKA_OUTPUT_TOPIC: processed-insights
      # Hybrid AI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}  # For Ollama use "ollama", for OpenAI use real key
      OPENAI_MODEL: ${OPENAI_MODEL:-llama3.1}  # For Ollama: llama3.1, mistral, etc. For OpenAI: gpt-4o-mini
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}  # Ollama endpoint (use host.docker.internal for local Ollama)
    ports:
      - "8082:8082"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow Docker to access host machine (for local Ollama)
    networks:
      - terraneuron-net

  terra-ops:
    build:
      context: ./services/terra-ops
      dockerfile: Dockerfile
    container_name: terra-ops
    depends_on:
      - kafka
      - mysql
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/terra_db
      SPRING_DATASOURCE_USERNAME: terra
      SPRING_DATASOURCE_PASSWORD: terra2025
    ports:
      - "8080:8080"
    networks:
      - terraneuron-net

networks:
  terraneuron-net:
    driver: bridge

volumes:
  mysql-data:
  influxdb-data:
  mosquitto-data:
  mosquitto-logs:
  prometheus-data:
  grafana-data:
